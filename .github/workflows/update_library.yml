name: Archive Auto-Update
on:
  push:
    paths:
      - 'pdfs/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Stream Update HTML
        run: |
          python -c "
          import os, re
          pdf_dir = 'pdfs'
          html_file = 'index.html'
          
          if not os.path.exists(pdf_dir): os.makedirs(pdf_dir)
          files = sorted([f for f in os.listdir(pdf_dir) if f.endswith('.pdf')])
          
          def get_tag(filename, tag):
              pattern = rf'{tag}=\[(.*?)\]'
              match = re.search(pattern, filename, re.IGNORECASE)
              return match.group(1).strip() if match else 'N/A'

          # Pre-generate all table rows
          new_rows_list = []
          for f in files:
              title = get_tag(f, 'Title')
              author = get_tag(f, 'Author')
              year = get_tag(f, 'Year')
              if title == 'N/A': title = f.replace('.pdf', '')
              new_rows_list.append(f'<tr><td><a href=\"pdfs/{f}\" target=\"_blank\">{title}</a></td><td>{author}</td><td>{year}</td></tr>')
          
          new_rows_html = '\n'.join(new_rows_list) + '\n'

          # Read and Rebuild Line-by-Line
          with open(html_file, 'r', encoding='utf-8') as f:
              old_lines = f.readlines()

          final_output = []
          in_list_zone = False

          for line in old_lines:
              if '' in line:
                  final_output.append(line)
                  final_output.append(new_rows_html)
                  in_list_zone = True
              elif '' in line:
                  final_output.append(line)
                  in_list_zone = False
              elif not in_list_zone:
                  # Update the counter line if it exists
                  if 'id=\"book-count\"' in line:
                      line = re.sub(r'id=\"book-count\">.*?</span>', f'id=\"book-count\">{len(files)}</span>', line)
                  final_output.append(line)

          with open(html_file, 'w', encoding='utf-8') as f:
              f.writelines(final_output)
          "

      - name: Save Changes
        run: |
          git config --global user.name 'Archive-Bot'
          git config --global user.email 'bot@github.com'
          git add index.html
          git commit -m "Automated update: Large-scale sync" || exit 0
          git push
