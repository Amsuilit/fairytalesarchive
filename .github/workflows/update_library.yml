name: Archive Auto-Update
on:
  push:
    paths:
      - 'pdfs/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Database File
        run: |
          python -c "
          import os, re, json
          pdf_dir = 'pdfs'
          if not os.path.exists(pdf_dir): os.makedirs(pdf_dir)
          files = sorted([f for f in os.listdir(pdf_dir) if f.endswith('.pdf')])
          
          def get_tag(f, tag):
              match = re.search(rf'{tag}=\[(.*?)\]', f, re.IGNORECASE)
              return match.group(1).strip() if match else 'N/A'

          db = []
          for f in files:
              title = get_tag(f, 'Title')
              if title == 'N/A': title = f.replace('.pdf', '')
              db.append({
                  't': title,
                  'a': get_tag(f, 'Author'),
                  'y': get_tag(f, 'Year'),
                  'f': f
              })
          
          # This writes a JavaScript file that the HTML can read
          with open('data.js', 'w', encoding='utf-8') as f:
              f.write('archiveData = ' + json.dumps(db) + ';')
          "

      - name: Save Data
        run: |
          git config --global user.name 'Archive-Bot'
          git config --global user.email 'bot@github.com'
          git add data.js
          git commit -m "Database updated" || exit 0
          git push
