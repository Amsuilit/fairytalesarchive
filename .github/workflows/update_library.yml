name: Scan PDFs and Update HTML
on:
  push:
    paths:
      - 'pdfs/**'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run Label-Based Scan
        run: |
          python -c "
          import os, re
          pdf_dir = 'pdfs'
          html_file = 'index.html'
          
          files = sorted([f for f in os.listdir(pdf_dir) if f.endswith('.pdf')])
          total_books = len(files)
          
          def get_tag(filename, tag):
              # Searches for Tag: [Content]
              pattern = rf'{tag}:\s*\[(.*?)\]'
              match = re.search(pattern, filename)
              return match.group(1).strip() if match else 'N/A'

          rows = ''
          for f in files:
              title = get_tag(f, 'Title')
              author = get_tag(f, 'Author')
              year = get_tag(f, 'Year')
              genre = get_tag(f, 'Genre')
              
              # If Title is missing, use the filename as a fallback
              if title == 'N/A': title = f.replace('.pdf', '')

              rows += f'<tr><td><a href=\"pdfs/{f}\" style=\"color:inherit;font-weight:bold;\">{title}</a></td><td>{author}</td><td>{year}</td><td><span class=\"genre-tag\">{genre}</span></td></tr>\n'
          
          with open(html_file, 'r', encoding='utf-8') as h:
              content = h.read()
          
          # Update List
          start_mark, end_mark = '', ''
          content = content.split(start_mark)[0] + start_mark + '\n' + rows + end_mark + content.split(end_mark)[1]
          
          # Update Counter
          content = re.sub(r'id=\"book-count\">.*?</span>', f'id=\"book-count\">{total_books}</span>', content)
          
          with open(html_file, 'w', encoding='utf-8') as h:
              h.write(content)
          "

      - name: Commit changes
        run: |
          git config --global user.name 'Archive-Bot'
          git config --global user.email 'bot@github.com'
          git add index.html
          git commit -m "Automated update: Labels parsed" || exit 0
          git push
